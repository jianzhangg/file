<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>个人动态学习仪表盘 (v-final-fix)</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.2.1/chartjs-plugin-annotation.min.js"></script>

<style>
    /* CSS部分和之前完全一样 */
    :root {
        --task-input: #0d6efd; --task-output: #198754; --task-review: #fd7e14;
        --task-warmup: #20c997; --task-break: #6c757d; --highlight-bg: #FFFBEA;
    }
    html { scroll-behavior: smooth; }
    body { background-color: #f8f9fa; }
    .dashboard-card {
        border: none; border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    .table-custom {
        border-collapse: separate; border-spacing: 0; border: none;
    }
    .table-custom thead.table-dark {
        background-color: #343a40; border-radius: 10px 10px 0 0;
    }
    .table-custom thead th:first-child { border-radius: 10px 0 0 0; }
    .table-custom thead th:last-child { border-radius: 0 10px 0 0; }
    .table-custom tbody tr {
        border-bottom: 1px solid #dee2e6;
        border-left: 6px solid transparent;
        transition: background-color 0.2s ease;
    }
    .table-custom tbody tr:last-child { border-bottom: none; }
    .table-custom td, .table-custom th { padding: 1.25rem; }
    .task-input { border-left-color: var(--task-input); }
    .task-output { border-left-color: var(--task-output); }
    .task-review { border-left-color: var(--task-review); }
    .task-warmup { border-left-color: var(--task-warmup); }
    .task-break { border-left-color: var(--task-break); }
    .task-input strong, .task-input td:first-child strong { color: var(--task-input); }
    .task-output strong, .task-output td:first-child strong { color: var(--task-output); }
    .task-review strong, .task-review td:first-child strong { color: var(--task-review); }
    .task-warmup strong, .task-warmup td:first-child strong { color: var(--task-warmup); }
    .task-break strong, .task-break td:first-child strong { color: var(--task-break); }
    .table-custom tr.highlight { background-color: var(--highlight-bg) !important; }
    @media screen and (max-width: 768px) {
        .table-custom thead { display: none; }
        .table-custom tbody, .table-custom tr, .table-custom td { display: block; width: 100%; }
        .table-custom tr { margin-bottom: 1rem; border: 1px solid #e9ecef; border-left-width: 6px; border-radius: .375rem; }
        .table-custom td { border: none; border-bottom: 1px solid #f1f3f5; }
        .table-custom td:last-child { border-bottom: none; }
        .table-custom td:before { content: attr(data-label); display: block; font-weight: 600; margin-bottom: .25rem; color: #6c757d; }
        .task-input td:before { color: var(--task-input); } .task-output td:before { color: var(--task-output); } .task-review td:before { color: var(--task-review); } .task-warmup td:before { color: var(--task-warmup); } .task-break td:before { color: var(--task-break); }
    }
    .legend-title, .chart-title { text-align: center; font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem; color: #343a40; }
    .legend-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 1.5rem; padding: 0; margin: 0; list-style: none; }
    .legend-item { display: flex; align-items: center; font-size: 1rem; color: #555; }
    .legend-color { width: 24px; height: 24px; border-radius: 6px; margin-right: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
</style>
</head>
<body class="bg-light">

<div class="container my-4">
    <div class="card dashboard-card">
        <div class="card-body p-4">
            <div id="status-bar" class="alert alert-light text-center fs-5 py-3">正在获取当前时间...</div>
            <table class="table-custom align-middle">
                <thead class="table-dark">
                    <tr><th>时间段</th><th>学习内容 (做什么)</th><th>原理解释 (为什么这么安排)</th></tr>
                </thead>
                <tbody id="schedule-body">
                     <tr id="task-0730" class="task-warmup"><td data-label="时间段"><strong>7:30 - 8:30</strong></td><td data-label="学习内容 (做什么)"><strong>沉浸式听力</strong><br>准备早餐、吃饭、晨间整理时，播放 <strong>`Feishu Minutes`</strong> 或 <strong>`Teacher Han's lessons`</strong> 的音频。</td><td data-label="原理解释"><strong>低强度预热</strong><br>让大脑“频道”调至英语，为专注学习做铺垫。</td></tr>
                    <tr id="task-0830" class="task-review"><td data-label="时间段"><strong>8:30 - 9:00</strong></td><td data-label="学习内容 (做什么)"><strong>昨日复盘</strong><br>打开 <strong>`DIDA review words`</strong>，回顾并消化<strong>昨天</strong>记录下的所有知识点。</td><td data-label="原理解释"><strong>激活短期记忆</strong><br>巩固旧知识，为学习新知识打下基础。</td></tr>
                    <tr id="task-0900" class="task-input"><td data-label="时间段"><strong>9:00 - 10:15</strong></td><td data-label="学习内容 (做什么)"><strong>核心输入：`Teacher Han's lessons`</strong><br>集中精力学习一节<strong>新课</strong>，并在 <strong>`DIDA`</strong> 中记下笔记。</td><td data-label="原理解释"><strong>精力巅峰期攻克新知</strong><br>在思维最清晰的时段学习系统性知识。</td></tr>
                    <tr id="task-1015" class="task-break"><td data-label="时间段"><strong>10:15 - 10:30</strong></td><td data-label="内容"><strong>短暂休息</strong></td><td data-label="说明">离开书桌，远眺，喝水，让大脑“充电”。</td></tr>
                    <tr id="task-1030" class="task-input"><td data-label="时间段"><strong>10:30 - 11:30</strong></td><td data-label="学习内容 (做什么)"><strong>专项练习：`Feishu Minutes Shadowing`</strong><br>对材料进行“刻意练习”，录音对比，反复打磨。</td><td data-label="原理解释"><strong>将输入转化为肌肉记忆</strong><br>高强度的口语输出练习，将“听懂”转化为“会说”。</td></tr>
                    <tr id="task-1130" class="task-output"><td data-label="时间段"><strong>11:30 - 12:15</strong></td><td data-label="学习内容 (做什么)"><strong>即时应用：`TalkAI talk with AI`</strong><br>围绕上午所学主题，与AI外教进行对话。</td><td data-label="原理解释"><strong>学以致用的第一步</strong><br>在安全的试错环境中立即实践新知识。</td></tr>
                    <tr id="task-1215" class="task-break"><td data-label="时间段"><strong>12:15 - 13:30</strong></td><td data-label="内容"><strong>午餐 & 完全休息</strong></td><td data-label="说明">让大脑彻底放空，恢复精力。</td></tr>
                    <tr id="task-1330" class="task-review"><td data-label="时间段"><strong>13:30 - 14:30</strong></td><td data-label="学习内容 (做什么)"><strong>词汇专项：`TalkAI memory words`</strong><br>系统地背单词，完成App里的学习任务。</td><td data-label="原理解释"><strong>分解学习任务</strong><br>将相对独立的单词记忆任务放在下午。</td></tr>
                    <tr id="task-1430" class="task-output"><td data-label="时间段"><strong>14:30 - 15:30</strong></td><td data-label="学习内容 (做什么)"><strong>异步交流：`Tandem` 文字聊天</strong><br>与语伴进行<strong>文字交流</strong>，并<strong>预约好晚上的语音通话</strong>。</td><td data-label="原理解释"><strong>低压输出与社交预热</strong><br>文字聊天有更多思考时间，为语音通话铺垫。</td></tr>
                    <tr id="task-1530" class="task-break"><td data-label="时间段"><strong>15:30 - 15:45</strong></td><td data-label="内容"><strong>茶歇</strong></td><td data-label="说明">短暂休息，切换学习模式。</td></tr>
                    <tr id="task-1545" class="task-review"><td data-label="时间段"><strong>15:45 - 17:00</strong></td><td data-label="学习内容 (做什么)"><strong>复习与准备</strong><br>1. 复习<strong>一周前</strong>的知识点。<br>2. 准备晚上Tandem聊天话题。</td><td data-label="原理解释"><strong>科学复习 & 有备而战</strong><br>间隔重复对抗遗忘，提前准备提升自信。</td></tr>
                    <tr id="task-1700" class="task-break"><td data-label="时间段"><strong>17:00 - 21:30</strong></td><td data-label="内容"><strong>晚餐、运动、洗澡</strong></td><td data-label="说明">身体和大脑的恢复期，可泛听音频保持语境。</td></tr>
                    <tr id="task-2130" class="task-output"><td data-label="时间段"><strong>21:30 - 22:15</strong></td><td data-label="学习内容 (做什么)"><strong>核心输出：`Tandem talk with foreigners`</strong><br>与预约好的语伴进行<strong>45分钟</strong>的语音或视频通话。</td><td data-label="原理解释"><strong>终极实战场</strong><br>检验一天成果，将知识转化为技能。</td></tr>
                    <tr id="task-2215" class="task-review"><td data-label="时间段"><strong>22:15 - 22:45</strong></td><td data-label="学习内容 (做什么)"><strong>复盘与捕获 (黄金30分钟)</strong><br>立刻记录通话中的新知识点和错误。</td><td data-label="原理解释"><strong>闭合学习循环</strong><br>趁热打铁，将错误转化为进步的阶梯。</td></tr>
                    <tr id="task-2245" class="task-review"><td data-label="时间段"><strong>22:45 - 23:15</strong></td><td data-label="学习内容 (做什么)"><strong>睡前巩固</strong><br>快速浏览今晚的新笔记。</td><td data-label="原理解释"><strong>利用睡眠魔法</strong><br>大脑会在睡眠中巩固睡前信息。</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="container my-4">
    <div class="card dashboard-card">
        <div class="card-body legend p-4">
            <h3 class="legend-title">颜色分类说明</h3>
            <ul class="legend-list">
                <li class="legend-item"><span class="legend-color" style="background-color: var(--task-input);"></span>核心输入</li>
                <li class="legend-item"><span class="legend-color" style="background-color: var(--task-output);"></span>主动输出</li>
                <li class="legend-item"><span class="legend-color" style="background-color: var(--task-review);"></span>复习巩固</li>
                <li class="legend-item"><span class="legend-color" style="background-color: var(--task-warmup);"></span>准备预热</li>
                <li class="legend-item"><span class="legend-color" style="background-color: var(--task-break);"></span>休息恢复</li>
            </ul>
        </div>
    </div>
</div>

<div class="container my-4">
    <div class="card dashboard-card">
        <div class="card-body chart-wrapper p-4">
            <h3 class="chart-title">每日精力变化曲线</h3>
            <canvas id="energyChart"></canvas>
        </div>
    </div>
</div>

<audio id="notification-sound" src="https://www.soundjay.com/buttons/sounds/button-16.mp3" preload="auto"></audio>

<script>
    // 使用 DOMContentLoaded 依然是最佳实践，确保DOM树可用
    document.addEventListener('DOMContentLoaded', function() {
        const notificationSound = document.getElementById('notification-sound');
        const notificationIcon = 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/6a/Feather-icon-book.svg/120px-Feather-icon-book.svg.png';

        let lastKnownTaskId = null, hasScrolled = false;
        const schedule = [
            { id: 'task-0730', start: 7.5, end: 8.5, name: '沉浸式听力' }, { id: 'task-0830', start: 8.5, end: 9.0, name: '昨日复盘' }, { id: 'task-0900', start: 9.0, end: 10.25, name: '核心输入：Teacher Han\'s lessons' }, { id: 'task-1015', start: 10.25, end: 10.5, name: '短暂休息' }, { id: 'task-1030', start: 10.5, end: 11.5, name: '专项练习：Feishu Minutes Shadowing' }, { id: 'task-1130', start: 11.5, end: 12.25, name: '即时应用：TalkAI talk with AI' }, { id: 'task-1215', start: 12.25, end: 13.5, name: '午餐 & 完全休息' }, { id: 'task-1330', start: 13.5, end: 14.5, name: '词汇专项：TalkAI memory words' }, { id: 'task-1430', start: 14.5, end: 15.5, name: '异步交流：Tandem 文字聊天' }, { id: 'task-1530', start: 15.5, end: 15.75, name: '茶歇' }, { id: 'task-1545', start: 15.75, end: 17.0, name: '复习与准备' }, { id: 'task-1700', start: 17.0, end: 21.5, name: '晚餐、运动、洗澡' }, { id: 'task-2130', start: 21.5, end: 22.25, name: '核心输出：Tandem talk with foreigners' }, { id: 'task-2215', start: 22.25, end: 22.75, name: '复盘与捕获 (黄金30分钟)' }, { id: 'task-2245', start: 22.75, end: 23.25, name: '睡前巩固' }
        ];

        function setupNotifications() {
            if ("Notification" in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        function sendNotification(task) {
            notificationSound.play().catch(e => console.error("声音播放失败:", e));
            if (Notification.permission === 'granted') {
                const title = task ? `新任务：${task.name}` : '休息时间到！';
                const body = task ? '请准备开始下一个学习环节。' : '好好放松，为下一个任务充电！';
                new Notification(title, { body: body, icon: notificationIcon });
            }
        }

        // --- 滚动逻辑函数 ---
        function performInitialScroll() {
            if (!hasScrolled) {
                const targetRow = document.querySelector('.highlight');
                if (targetRow) {
                    targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    hasScrolled = true;
                }
            }
        }

        const ctx = document.getElementById('energyChart').getContext('2d');
        const energyChart = new Chart(ctx, { 
            type: 'line', 
            data: { labels: [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23], datasets: [{ label: '精力水平', data: [30, 60, 95, 90, 80, 65, 50, 40, 60, 75, 70, 60, 55, 50, 45, 30, 20], fill: true, borderColor: 'rgba(75, 192, 192, 1)', backgroundColor: 'rgba(75, 192, 192, 0.2)', tension: 0.4 }] }, 
            options: { 
                scales: { y: { beginAtZero: true, max: 100, title: { display: true, text: '精力水平 (0-100)' } }, x: { type: 'linear', min: 7, max: 23, title: { display: true, text: '时间 (24小时制)' } } }, 
                plugins: { legend: { display: false }, annotation: { annotations: { currentTimeLine: { type: 'line', scaleID: 'x', value: 7, borderColor: 'red', borderWidth: 2, label: { enabled: true, content: '当前时间', position: 'start' } } } } },
                // --- 关键改动：在这里添加 onComplete 回调 ---
                animation: {
                    onComplete: () => {
                        performInitialScroll();
                    }
                }
            } 
        });
        
        function masterUpdate() {
            const now = new Date(); const currentTime = now.getHours() + now.getMinutes() / 60; const formattedTime = now.toLocaleDateString('zh-CN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }); let currentTask = null;
            document.querySelectorAll('#schedule-body tr').forEach(row => { row.classList.remove('highlight'); });
            for (const task of schedule) { if (currentTime >= task.start && currentTime < task.end) { currentTask = task; break; } }
            const newTaskId = currentTask ? currentTask.id : 'break';
            if (newTaskId !== lastKnownTaskId) { sendNotification(currentTask); lastKnownTaskId = newTaskId; }
            
            const statusBar = document.getElementById('status-bar');
            if (currentTask) {
                const targetRow = document.getElementById(currentTask.id);
                if (targetRow) { targetRow.classList.add('highlight'); } // 高亮逻辑依然在这里
                if (targetRow && targetRow.classList.contains('task-break')) { statusBar.innerHTML = `<strong>${formattedTime}</strong><br>当前是：<strong>${currentTask.name}</strong>，请好好放松！`; } else { statusBar.innerHTML = `<strong>${formattedTime}</strong><br>当前任务：<strong>${currentTask.name}</strong>，请保持专注！`; }
            } else {
                let nextTask = schedule.find(task => task.start > currentTime);
                if(nextTask){ statusBar.innerHTML = `<strong>${formattedTime}</strong><br>学习时间结束。下一个任务是：<strong>${nextTask.name}</strong>`; } else { statusBar.innerHTML = `<strong>${formattedTime}</strong><br>今天辛苦了！所有学习任务已完成。`; }
            }
            energyChart.options.plugins.annotation.annotations.currentTimeLine.value = currentTime;
            energyChart.update('none');
        }

        setupNotifications();
        masterUpdate(); // 首次执行，高亮当前行
        setInterval(masterUpdate, 1000); // 每秒更新
    });
</script>
</body>
</html>
